/**
 * MCP Client Helper
 * Auto-generated by mcp-to-claude-skill
 *
 * This module provides a helper function to call MCP tools with type safety.
 */

import { Client } from "@modelcontextprotocol/sdk/client/index.js";
import { StdioClientTransport } from "@modelcontextprotocol/sdk/client/stdio.js";

interface MCPClientConfig {
  command: string;
  args: string[];
}

/**
 * Global MCP client instance
 */
let mcpClient: Client | null = null;
let mcpTransport: StdioClientTransport | null = null;
let isConnected = false;

/**
 * Initialize the MCP client connection
 * This should be called once before using any tools
 */
export async function initializeMCPClient(config: MCPClientConfig): Promise<void> {
  if (isConnected) {
    console.warn("MCP client already initialized");
    return;
  }

  mcpClient = new Client(
    {
      name: "mcp-skill",
      version: "1.0.0",
    },
    {
      capabilities: {},
    }
  );

  mcpTransport = new StdioClientTransport({
    command: config.command,
    args: config.args,
  });

  await mcpClient.connect(mcpTransport);
  isConnected = true;
}

/**
 * Close the MCP client connection
 */
export async function closeMCPClient(): Promise<void> {
  if (mcpClient && isConnected) {
    await mcpClient.close();
    isConnected = false;
    mcpClient = null;
    mcpTransport = null;
  }
}

/**
 * Call an MCP tool with type-safe inputs and outputs
 *
 * @param toolName - The name of the MCP tool to call
 * @param input - The input parameters for the tool
 * @returns The tool response
 */
export async function callMCPTool<TOutput = any>(
  toolName: string,
  input: any
): Promise<TOutput> {
  if (!mcpClient || !isConnected) {
    throw new Error(
      "MCP client not initialized. Call initializeMCPClient() first."
    );
  }

  try {
    const response = await mcpClient.callTool({
      name: toolName,
      arguments: input,
    });

    // MCP returns content array, extract the text content
    if (response.content && Array.isArray(response.content)) {
      // Try to parse JSON from text content
      const textContent = response.content.find((c) => c.type === "text");
      if (textContent && "text" in textContent) {
        try {
          return JSON.parse(textContent.text) as TOutput;
        } catch {
          // If not JSON, return the raw text wrapped in the output structure
          return {
            content: response.content,
            isError: response.isError,
          } as TOutput;
        }
      }
    }

    // Return raw response if no text content
    return response as TOutput;
  } catch (error) {
    if (error instanceof Error) {
      throw new Error(`MCP tool call failed: ${error.message}`);
    }
    throw error;
  }
}

/**
 * Check if the MCP client is connected
 */
export function isClientConnected(): boolean {
  return isConnected;
}
